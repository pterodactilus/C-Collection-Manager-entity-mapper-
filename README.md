<p><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=ea-trifonoff@yandex.ru&amp;lc=US&amp;item_name=Collection+Manager+(entity+mapper)&amp;no_note=0&amp;no_shipping=2&amp;curency_code=USD&amp;bn=PP-DonationsBF:btn_donateCC_LG.gif:NonHosted" target="_blank" rel="noopener">You can <span class="alert"><strong>Help CCM (C# Collections Mapper) project</strong> </span> by modest donation. Thanks! </a></p>
<p><strong>Download demo solution</strong><br /> <a href="https://sourceforge.net/projects/collectionmanager/files/" rel="nofollow">https://sourceforge.net/projects/collectionmanager/files/</a><br /> <a href="https://github.com/pterodactilus/C-Collection-Manager-entity-mapper-">https://github.com/pterodactilus/C-Collection-Manager-entity-mapper-</a><br /><br /> <br /><strong><span class="alert">CCM (C# Collections Mapper)</span> </strong>is a working version of the handwritten mini ORM, working with the database and .Net collections. Productivity is quite high, resource consumption is minimal.<br /> This ORM works directly with SQL Server stored procedures.&nbsp;The code is accompanied by descriptions and example .Net Console project showing the technique of ORM using.<br /><br /> <strong>Introduction</strong><br /><br /> Data is stored on the SQL server and when a large number of simultaneously connected users access it this creates a serious load on the database server. In addition, often database queries fetch the same data, which is not good in terms of server and applications load. One of ways to optimize the database in ligament with client application is to reduce traffic and to store data already received from the server on the client or in the middle application tier. Or to store already received data on the application server, especially when the database server and client applications are distributed across the network. For this purpose, the collections stored in the Session or at the application level are the best suited. <br /><a name="habracut"></a><br /> Below is a solution for the data management layer in the combination of MS Sql Server with a C # application, suitable for .Net. In whole this is a loosely bound entity mapper projecting the application's business logics onto database tables using T-SQL stored procedures. In this realization of ORM the tables, procedures, and entity constructors are written by hand. They are not generated automatically by a mapper. <br /><br /> At the same time, the entity code and stored procedures can be minimased and simplified and fully control by the developer. As well as a process of data obtaining. All client code is reduced to writing the simplest one string calls to the mappers methods and to creating the simplest constructors for entities by template.<br /><br />CCM allows you to implement fairly complex data structures in your application, without bothering about difficult and tedious questions of data acquisition and conversion issue, allowing you to pay more attention to the develop of business logic and UI. There no need to worry about migrations, context, etc. At the same time, ORM completely relieves the developer from direct communicating with ADO - datasets, tables, rows, and other data aceess component, to track connections, commands or operate with adapters because ORM works at a higher level of data abstraction. At the same time you will be completely protected from memory leaks and free to create complexity application logic at the primary data level. <br /><br /> At the same time you are free for create any complexity application logic at the primary data level. <br /><br /> <strong>General description and principles</strong><br /><br /> As an example, here are all the necessary to work with collection client application classes using the library CollectionManager. The library is universal and operates with any types of collections. Entity classes developer manually creates in the application. They allows him to get data from SQL server through stored procedures. This data form instances of the entity class and form from these instances the collection. <br /><br /> In addition, the library has mechanisms for extracting a specific an instance of a class from the collection, modifying it, and inserting it back into the collection to the same place (sort by ID). The library contains methods for adding and removing instances of the collection (Not records in the tables!!! For this purposes used "ExecuteNonQuery" method of sqlManager class. Developer should independently take care of maintaining the relevance of the tables. ORM only provides a convenient tool for this.<br /><br />"<em>Book</em>" is an example of a prototype class with instances of which an sample collections works.<br /> <br /> This is the class describing the mapping of the database table structure to entity. Sets of fields in a class can arbitrarily relate to the fields of the tables generating the entity. <br /><br /> <strong>How to use this?</strong><br /><br /> First you should add to your code necessary namespaces. <br /><br /><em><span class="style2" style="color: #3366ff;">using ...</span><span class="style2" style="color: #3366ff;">&nbsp;</span><br class="style2" /><span class="style2" style="color: #3366ff;">using CS_Collections_Mapper; </span></em></p>
<p><em> <br class="style2" /></em><strong><span class="style2">Define mapper and sqlManager</span></strong><span class="style2"> in client class</span><em><br class="style2" /> <br class="style2" /><span style="color: #3366ff;">ICollectionManager mapper = Repository.Mapper;</span></em><br /><span style="color: #3366ff;"><em> ISQLManager sqlManager = Repository.TsqlManager;</em></span></p>
<p>&nbsp;</p>
<p><span class="style2"><strong>Store <span style="color: #3366ff;"><em>Mapper</em> </span>and <span style="color: #3366ff;"><em>TsqlManager&nbsp;</em></span></strong><em>in application level</em></span></p>
<p><span style="color: #3366ff;"><em>public sealed class Repository : Singleton&lt;Repository&gt;</em></span><br /><span style="color: #3366ff;"><em> {</em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp; public static ICollectionManager Mapper = new CollectionManager();</em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp; public static ISQLManager TsqlManager = new SQLManager();</em></span><br /><span style="color: #3366ff;"><em> }</em></span></p>
<p><br /> <strong>How to connect to DB </strong> <br /><br /><span class="style2" style="color: #3366ff;"><em>ISQLManager</em></span> interface has several methods to establish the connection to data base. You should to create connection before you make any operations with <span class="style2" style="color: #3366ff;"><em>mapper</em> </span>or <span class="style2" style="color: #3366ff;"><em>sqlManager</em></span>. Here they are: <br /><br />Add connections methods <br /><br /><em><span class="style2" style="color: #3366ff;">string GetConfigPath(string pathKey, string configName, string subFolder) </span><br class="style2" /><span class="style2" style="color: #3366ff;">void AddConnection(string connAlias, string connectionString) </span><br class="style2" /><span class="style2" style="color: #3366ff;">void AddDefaultConfigConnections() </span><br class="style2" /><span class="style2"><span style="color: #3366ff;">void AddCustomConfigConnections(string configPath)</span> </span></em> <br /><br />Get connections methods <br /><br /><em><span class="style2" style="color: #3366ff;">string GetConnectionStringByAlias(string connAlias) </span><br class="style2" /><span class="style2"><span style="color: #3366ff;">Dictionary GetConnections()</span> </span></em> <br /><br />Remove connections methods <br /><br /><em><span class="style2" style="color: #3366ff;">void RemoveConnection(string connAlias) </span><br class="style2" /><span class="style2"><span style="color: #3366ff;">void RemoveConnections()</span> </span></em> <br /><br /> If your application is of classic <strong>.Net Framework</strong> type, you can use connection strings defined in <strong>web.config</strong> or <strong>app.config</strong> files. In this case call the <br /><br /> <span class="style2" style="color: #3366ff;"><em>AddDefaultConfigConnections()</em></span> method. <br /> <br />After this you can use connection aliases to pass it as a parameter to call <span class="style2" style="color: #3366ff;"><em>mapper</em> </span>or <span class="style2" style="color: #3366ff;"><em>sqlManager</em> </span>to operate with DB. You may have additional config files in application folders.</p>
<p>If this files contains <strong>ConnectionStrings</strong> sections the connections may be added to connection collection of <span class="style2"><em> sqlManager</em></span> and you can use it by its alias. <br /><br />To add this connections call the <span class="style2" style="color: #3366ff;"><em>AddCustomConfigConnections(string configPath)</em></span> method, where <span class="style2" style="color: #3366ff;"><em>configPath</em> </span>a phisical path to custom config file. <br />To get and pass the path for this config file to <span class="style2" style="color: #3366ff;"><em>AddCustomConfigConnections</em></span> method call the <span class="style2" style="color: #3366ff;"><em>GetConfigPath(string pathKey, string configName, string subFolder)</em></span> method with <span class="style2" style="color: #3366ff;"><em>configName</em> </span>and <span class="style2" style="color: #3366ff;"><em>subFolder</em> </span>parameters with empty <span class="style2"><em>pathKey</em></span> parameter. <br /><br />Or call <span class="style2" style="color: #3366ff;"><em>GetConfigPath(string pathKey, string configName, string subFolder)</em></span> with config key <span class="style2" style="color: #3366ff;"><em>pathKey</em> </span>with physical path from <strong>app.config</strong> or<strong> web.config</strong> files and empty <span class="style2" style="color: #3366ff;"><em>configName</em> </span>and <span class="style2" style="color: #3366ff;"><em>subFolder</em> </span>parameters. <br />You can add connections manually by calling the <span class="style2" style="color: #3366ff;"><em>AddConnection(string connAlias, string connectionString) </em></span>method. This may be usefull if you have no config files in application, e.g. if your application is of<strong> .Net Core </strong>type. <br />Also you can get, check and remove connections by calling <span style="color: #3366ff;"><em><span class="style2"> GetConnectionStringByAlias(string connAlias) </span></em></span>and <span class="style2" style="color: #3366ff;"><em>RemoveConnection(string connAlias) </em> </span><span class="style3">methods.</span><br class="style2" /> <br class="style2" /><span class="style3"><strong>Example of how to get</strong></span> <span class="style3"> <strong>the collection</strong></span><br class="style2" /><br class="style2" /> <span style="color: #3366ff;"><em><span class="style2">public ICollection&lt;Book&gt; GetBooks(string connAlias, Guid creatorID) </span><br class="style2" /><span class="style2">{ </span></em></span></p>
<p><span style="color: #3366ff;"><em>&nbsp; &nbsp; Hashtable parameters = new Hashtable();<br />&nbsp; &nbsp; parameters["@CreatorID"] = creatorID;</em></span></p>
<p><span style="color: #3366ff;"><em><br class="style2" /> <span class="style2">&nbsp; &nbsp; return mapper.GetCollection&lt;Book&gt; </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp; ( </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Repository.AllBooks,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #339966;">// destination collection</span> </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "GetTestBooks",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #339966;">&nbsp; &nbsp;// Stored procedure name </span></span> <br class="style2" /> <span class="style2">&nbsp; &nbsp; &nbsp; &nbsp; connAlias,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #339966;">// connection string alias(defined in config) </span></span> <br class="style2" /> <span class="style2">&nbsp; &nbsp; &nbsp; &nbsp; parameters,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #339966;">// Stored procedure parameters</span> </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #339966;">&nbsp;// *see explanation below </span></span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp; ); </span><br class="style2" />}</em></span></p>
<p><strong>Initial filling of collections with elements</strong><br /><br /> Pay attention to the last boolean "true" parameter in the <em>GetCollection </em>method. If we omit the last optional bool parameter in the <span class="style2"><em>mapper.GetCollection </em></span>call, the mapper will get instances from database by two passes. At first the stored procedure pulls out a list of entity IDs by which instances are searched for in database table.&nbsp;<br /><br /> After receiving the list of&nbsp;<strong><span style="color: #3366ff;"><em>id </em></span></strong><span style="color: #3366ff;"><span style="color: #333333;">values</span></span>, the mapper looks for instances with their Id in the heap collection. If the instancea are already in the heap collection, mapper returns the instance of searched entity type with this Id to destination collection. And if mapper is not found instance in the heap it take it from the database. There will be called entity's constructor and the new item will be added to the heap and to destination collection from database. See entity Book class example for details<br /><br /> If this last boolean parameter in the <em>GetCollection </em>method is set to <em><span style="color: #3366ff;">true</span> </em>the <em><span style="color: #3366ff;">@ReturnAtOnce</span> </em>parameter will be passed to the SQL procedure, then the procedure returns the entire record set in one pass with all the entity fields.&nbsp;<br /><br /> <strong>Example of an element retrieval</strong> method from collection (<span style="color: #3366ff;"><em>Book</em> </span>instance)<br /> If instance with this Id not present in collection, it will be added to collection from db table <br /><br /> <br /><span style="color: #3366ff;"><em><span class="style2">public Book GetBook(int bookId, ICollection&lt;Book&gt; collection) </span> <br class="style2" /><span class="style2">{ </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp; return mapper.GetCollectionItem&lt;Book&gt;(collection, bookId); </span> <br class="style2" /></em>}</span><em><br /></em><br /> <strong>Example for update</strong> method of collection instance</p>
<p>While updating, item instance will be deleted and recreated in collection with new one. The position of new instance in collection will not changed and remain the same. If instance with item Id is not present in collection, it will NOT be added to collection and no action will perform.<br /><br /> <em><span class="style2" style="color: #3366ff;">public void UpdateBook(int bookID) </span></em><br class="style2" /><em><span class="style2" style="color: #3366ff;">{ </span></em><br class="style2" /><em><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; mapper.UpdateCollectionItem(Repository.UserBooks, bookID); </span></em><br class="style2" /><em><span style="color: #3366ff;"> }</span></em><br /><br /> <strong>Example for delete from database table</strong>.</p>
<p>You should create procedure for delete row from table (if it is still not present in database) <em> <br /><br /> <span class="style4" style="color: #ff9900;">Create PROCEDURE [dbo].[DeleteBooks] @BookID int AS </span><br class="style4" /> <br class="style4" /><span class="style4" style="color: #ff9900;">IF @BookID is not null </span><br class="style4" /><span class="style4" style="color: #ff9900;"> -- delete specific book </span><br class="style4" /><span class="style4" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; Delete FROM Books </span><br class="style4" /><span class="style4" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; WHERE (BookID = @BookID) </span><br class="style4" /><span class="style4" style="color: #ff9900;">RETURN</span><br /><br /></em> Calling this stored procedure<em><br /><br /> <span class="style2" style="color: #3366ff;">Hashtable parameters = new Hashtable(); </span><br class="style2" /><span class="style2" style="color: #3366ff;">parameters["@BookID"] = bookID; </span><br class="style2" /><span class="style2" style="color: #3366ff;">string errMsg = string.Empty; </span><br class="style2" /><span class="style2" style="color: #3366ff;">sqlManager.ExecuteNonQuery("CmsDb", "DeleteBooks", parameters, out errMsg);</span><br /></em> <br />If you have changed the database tables on base of which the collection was built, you may need to update collection with its items. Now we remove instance from collection for deleted table row.&nbsp;<em><br /> <br /> <strong>Example for remove</strong> <strong>instance&nbsp;</strong><br /><br /> <span class="style2" style="color: #3366ff;">public void RemoveBook(int bookID, ICollection&lt;Book&gt;collection)</span><br class="style2" /><span style="color: #3366ff;"> {</span><br class="style2" /><span class="style2" style="color: #3366ff;">&nbsp;&nbsp;&nbsp; mapper.RemoveCollectionItem(collection, bookID);</span><br class="style2" /><span style="color: #3366ff;"> }</span><br /><br /></em> The same action (more simple and quickly)<em><br /><br /> <span class="style2" style="color: #3366ff;">Repository.UserBooks.Remove(book);</span><br /> <br /></em>If you have to change one or two items you may use <span class="style2"><em>mapper.UpdateCollectionItem</em></span> method. But if you source tables have changed significally the better way is to recreate the whole collection one more time. For this purpose you should to clear collection(optional) and refill it with renewed instances.<br /> <br /> Use the <span class="style2" style="color: #3366ff;"><em>collection.Clear()</em></span> and <span style="color: #3366ff;">mapper.<span class="style2"><em>GetCollection()</em></span></span> methods.<br /><br /> <strong>Example implementation of an entity</strong> class <em> <br /><br /><span class="style2" style="color: #3366ff;">public class Book : Sortable </span><br class="style2" /><span class="style2" style="color: #3366ff;">{ </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public int BookID <span class="style2">{ get; set; } </span></span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public double Rating { get; set; } </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public DateTime DateCreation { get; set; } </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public string Caption { get; set; } </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public Guid CreatorID { get; set; } </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public bool Published { get; set; } </span></em></p>
<p><em><br class="style2" /> <span style="color: #3366ff;">&nbsp;&nbsp;&nbsp; public Book(..) </span><br /><span style="color: #3366ff;">&nbsp;&nbsp;&nbsp; {</span><br /><span style="color: #3366ff;">&nbsp; &nbsp; &nbsp; ... <span style="color: #339966;">//create Book manually</span></span><br /><span style="color: #3366ff;">&nbsp; &nbsp; }</span> <br class="style2" /></em></p>
<p><em><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public Book(IDataReader reader, int sortID) : base(reader, sortID) </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; { </span><br class="style2" /> <span class="style2"><span style="color: #3366ff;">&nbsp;&nbsp;&nbsp; }</span> <br /> </span> <br class="style2" /></em></p>
<p><span class="style3">You should specify the entity key field in collection constructor (not in the entity class) to tell mapper what is the key of entity in collection. It may have any name. Public field <em>BookID&nbsp;</em>in example above is differs from the default&nbsp;<em>ID</em>&nbsp;name. For convinence the key field may&nbsp;have the same name as primary key field or it alias, returned by stored procedure.</span></p>
<p><span class="style3">The <span style="color: #3366ff;"><em>BookID&nbsp;</em></span></span><span class="style3">variable in constructor below is a <span style="text-decoration: underline;">stored procedure key parameter</span> for seek the row in the <em>Books</em> table. It may have the same name as a class key field name but in this constructor definition it means another thing.&nbsp;You can omit this parameter if the <em>Get</em> stored procedure input key parameter named as "<em>ID"</em>. The key parameter in <em>GetTestBooks</em> procedure has the name <span style="color: #3366ff;"><em>BookID</em></span>, that is why we should point it also in a constructor signature.&nbsp;</span></p>
<p><em><br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp; </span><span class="style2" style="color: #3366ff;">public Book(int id_key, int sortID) : base(id_key, sortID, "CmsDb", "GetTestBooks", "<span class="style3">BookID</span>") </span></em><br class="style2" /><span style="color: #3366ff;"><em> <span class="style2">&nbsp;&nbsp;&nbsp; { </span> </em></span><br class="style2" /><span style="color: #3366ff;"><em> <span class="style2">&nbsp;&nbsp;&nbsp; } </span></em></span></p>
<p><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp;&nbsp;<span style="color: #339966;">&nbsp;// the set of fields relevant for the entity is defined in the procedure&nbsp; </span></span></em></span></p>
<p><span style="color: #3366ff;"><em><span class="style2">&nbsp; &nbsp; public override void MapEntityFields(IDataReader reader, int sortID)</span> </em></span><br class="style2" /><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp; { </span></em></span><br class="style2" /><span style="color: #3366ff;"><em><span class="style2"><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp;// automatically filling entity fields that has the same names as reader returns&nbsp;</span></span></em></span></p>
<p><em style="color: #3366ff;"><span class="style2">&nbsp; &nbsp; &nbsp; &nbsp;AutoMapEntity(reader, typeof(Book), this, sortID);</span></em></p>
<p><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try </span> </em></span><br class="style2" /><span style="color: #3366ff;"><em> <span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></em></span><br class="style2" /><span style="color: #339966;"><em> <span class="style2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // filling entity fields manually. works faster than AutoMapEntityFields<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // but require more code. here we can process data transformations</span></em></span></p>
<p><em style="color: #3366ff;"><span class="style2">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreatorID = Guid.Parse(reader["CreatorID"].ToString());&nbsp;</span></em></p>
<p><span style="color: #3366ff;"><em> <span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } </span> </em></span><br class="style2" /><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ex) </span> </em></span><br class="style2" /><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { </span> </em></span><br class="style2" /><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } </span> </em></span><br class="style2" /><span style="color: #3366ff;"><em><span class="style2">&nbsp;&nbsp;&nbsp; }</span></em></span><br class="style2" /><span class="style2" style="color: #3366ff;"> <em>}</em> </span> <br class="style2" /><br />All work with the data is reduced to writing the simple stored procedures for each entity and to create classes describing collections and methods for operations with them (storage, retrieval, modification) <br /><br /> <strong>SQL stored procedure to get Books</strong> data<em><br /><br /> <span class="style5" style="color: #ff9900;">Create PROCEDURE [dbo].[GetTestBooks] </span><br class="style5" /><span class="style5" style="color: #ff9900;">@CreatorID nvarchar(50) = null, </span><br class="style5" /><span class="style5" style="color: #ff9900;">@BookID int = null, </span><br class="style5" /><span class="style5" style="color: #ff9900;">@ReturnAtOnce bit = null </span><br class="style5" /> <br class="style5" /><span class="style5" style="color: #ff9900;"> AS </span><br class="style5" /> <br class="style5" /><span class="style5" style="color: #ff9900;"> IF&nbsp;<span class="style5">@BookID is not null </span><br class="style5" /><span class="style5"> &nbsp;&nbsp;&nbsp; </span><br class="style5" /><span class="style5"> &nbsp;&nbsp;&nbsp; -- specific book </span><br class="style5" /><span class="style5"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT BookID, Caption, CreatorID, DateCreation, PhotoID, Published, Position, Modified, </span><br class="style5" /><span class="style5"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rating, ForeignBook, TextID </span><br class="style5" /><span class="style5"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM Books </span><br class="style5" /><span class="style5"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHERE (BookID = @BookID) </span><br class="style5" /> </span></em></p>
<p><em><span class="style5" style="color: #ff9900;"><span class="style5">ELSE&nbsp;IF&nbsp;</span>@CreatorID is not null </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; -- user books </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; begin </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @ReturnAtOnce is not null </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT BookID, Caption, CreatorID, DateCreation, PhotoID, Published, </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Position, Modified, Rating, ForeignBook, TextID </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM Books </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHERE (CreatorID = @CreatorID) </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT BookID </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM Books </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHERE (CreatorID = @CreatorID) </span></em></p>
<p><em><span class="style5">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff9900;">ORDER BY DateCreation DESC </span></span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; end </span><br class="style5" /><br class="style5" /><span class="style5" style="color: #ff9900;">ELSE </span><br class="style5" /> <br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;-- all books </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; begin </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @ReturnAtOnce is not null </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT BookID, Caption, CreatorID, DateCreation, PhotoID, Published, </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Position, Modified, Rating, ForeignBook, TextID </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM Books </span><br class="style5" /><span class="style5" style="color: #ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="style5">ORDER BY DateCreation DESC</span></span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else </span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT BookID FROM Books </span><br class="style5" /><span class="style5" style="color: #ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="style5">ORDER BY DateCreation DESC</span></span><br class="style5" /><span class="style5" style="color: #ff9900;"> &nbsp;&nbsp;&nbsp; end </span><br class="style5" /><span class="style5" style="color: #ff9900;">RETURN</span><br /><br /></em> We may build any amount of collections with the same prototype entity class where the base class being used is the same. In the examples below, two different collections are used. It is important to note that instances of one collection we get from another. With such approach we did not store the same instances in memory twice and did not pull the same data from SQL server for several times.<br /><br /> For example, we have a store of books and it is divided into several shelfs. In one shelf is books for sale, and in other shelfs books for reading. If you put a book in the wrong shelf (e.g. in BooksList collection), someone will be surprised with pleasure, and someone will loss it. In the store there will remain the changeless amount of books and it does not change (we operate only with links to instances).<br /><br /> It is important that in all shelfs there are only books and between them are no principal different. My books I take from the shelf for reading. On this shelf books fall from the store (heaps).</p>
<p>If I have read all my books, I can go to the store (to the heap) and take another books for reading, or I can order the new ones if they not exists in the store (create new instanses in collection).</p>
<p><strong>Declaring entity collections&nbsp;</strong></p>
<p><span class="style2">By default collections stored at Application level if they will be accessed from different places of application and reused. But you are free to define them anywhere.&nbsp;</span></p>
<p><span style="color: #3366ff;"><em><span class="style2">UserBooks&nbsp;</span></em></span>collection get it instanses from the heap <span style="color: #3366ff;"><em><span class="style2">Repository.AllBooks </span> </em></span></p>
<p><span style="color: #3366ff;"><em>public static ICollection&lt;Book&gt; UserBooks = new UserBooks() as ICollection&lt;Book&gt;;</em></span></p>
<p><em><span style="color: #3366ff;">AllBooks</span> </em>is the heap from which the rest of child collections are assembled with the <em><span style="color: #3366ff;">Book</span> </em>entity prototype</p>
<p><strong>The heap collection declaration</strong><br /> <em> <br /> <span class="style2" style="color: #3366ff;">public class BooksHeap : BaseCollection&lt;Book&gt; </span><br class="style2" /><span class="style2" style="color: #3366ff;">{ </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; public BooksHeap() </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; { </span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #339966;">// Specify the collection key field (<span style="color: #ff0000;">required</span>!)</span></span><br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; idFieldName = "BookID"; </span></em></p>
<p><em><span style="color: #339966;">&nbsp; &nbsp; &nbsp; &nbsp; // secondaryID definition (optional)</span><br />&nbsp; &nbsp; &nbsp; &nbsp; idFieldName2 = "Position";<br class="style2" /><span class="style2" style="color: #3366ff;"> &nbsp;&nbsp;&nbsp; } </span><br class="style2" /></em><span style="color: #3366ff;">}</span></p>
<p><span style="color: #000000;"><strong>The child collection&nbsp;declaration</strong></span></p>
<p><br /><span style="color: #3366ff;"> <em>public class UserBooks : BooksHeap</em></span><br /><span style="color: #3366ff;"><em> {</em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp; public UserBooks()</em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp;{</em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #339966;">// indicate that instances are stored on the heap</span></em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp; &nbsp; &nbsp;heapCollection = Repository.AllBooks;</em></span><br /><span style="color: #3366ff;"><em>&nbsp; &nbsp;}</em></span><br /><span style="color: #3366ff;"><em> }</em></span></p>
<p><strong>Storing collections for reuse</strong></p>
<p><span style="color: #3366ff;"><em>public static ICollection&lt;Book&gt; AllBooks = new BooksHeap() as ICollection&lt;Book&gt;;</em></span></p>
<p><span style="color: #000000; background-color: #ffffff;">The relaition parent/child between collections is defined in this maner</span></p>
<p><span style="color: #3366ff;"><em>&nbsp;heapCollection = Repository.AllBooks;</em></span></p>
<p>&nbsp;</p>
<p><br /><strong>Examples of using </strong><span class="style2" style="color: #3366ff;"><em><strong>SqlManager</strong></em></span><strong> library.</strong></p>
<p>For delete, create and update records <span style="text-decoration: underline;">in the database tables</span> use <span style="color: #3366ff;"><em>SQLManager&nbsp;</em></span>class. Calling stored procedure for execute (e.g. add new Book to database)<em><br /> <br /> <span class="style2"><span style="color: #3366ff;">sqlManager.ExecuteNonQuery(dbAlias, procName, parameters, out errMsg);</span> </span> <br /> <br /> </em> or with retrieving some results from procedure as<span style="color: #3366ff;"><em>&nbsp;object[]</em></span><br /><br /> <span class="style2" style="color: #3366ff;"> <em>sqlManager.SQLExecuteScalar(dbAlias, procName, parameters)</em></span><br /><br /><strong>Example for create stored procedure to add</strong> new books<br /><br /><span style="color: #ff9900;"><em><span class="style5">Create PROCEDURE [dbo].[AddBook] </span> <br class="style5" /><span class="style5">@Caption nvarchar(100), </span> <br class="style5" /><span class="style5">@CreatorID nvarchar(50) </span> <br class="style5" /> <br class="style5" /><span class="style5">AS </span> <br class="style5" /> <br class="style5" /> <span class="style5">Declare @Position int </span> <br class="style5" /><span class="style5">SELECT @Position = Count(Books.BookID) + 1 </span> <br class="style5" /> <span class="style5">FROM Books </span> <br class="style5" /> <span class="style5">WHERE Books.CreatorID = @CreatorID </span> <br class="style5" /> <br class="style5" /> <span class="style5">INSERT INTO Books (Caption, PhotoID, CreatorID, Published, DateCreation, </span> <br class="style5" /> <span class="style5">Position, Modified, Rating, TextID) </span> <br class="style5" /><span class="style5">VALUES (@Caption, 0, @CreatorID, 0, GetDate(), @Position, GetDate(), 0, 0) </span> <br class="style5" /> <br class="style5" /> <span class="style5">Select scope_identity() AS NEW_BookID </span> <br class="style5" /><span class="style5">RETURN</span></em></span><br /><br />and how to execute it<br /><br /> <span style="color: #3366ff;"><em><span class="style2">Hashtable parameters = new Hashtable(); </span> <br class="style2" /><span class="style2">parameters["@Caption"] = "My new book"; </span> <br class="style2" /><span class="style2">parameters["@CreatorID"] = Guid.NewGuid(); </span> <br class="style2" /><span class="style2">int newBookId = -1; </span> <br class="style2" /> <br class="style2" /> <span class="style2">try </span> <br class="style2" /><span class="style2">{ </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp; Int32.TryParse(sqlManager.SQLExecuteScalar("CmsDb", "AddBook", parameters).ToString(), out newBookId); </span> <br class="style2" /><span class="style2">} </span> <br class="style2" /><span class="style2">catch (Exception ex) </span> <br class="style2" /><span class="style2">{ </span> <br class="style2" /><span class="style2">} </span> <br class="style2" /> <br class="style2" /> <span class="style2">if (newBookId &gt; 0) </span> <br class="style2" /><span class="style2">{ </span> <br class="style2" /> <span class="style2">&nbsp;&nbsp;&nbsp;<span style="color: #339966;"> // some actions with newBookId</span> </span> <br class="style2" /> </em> }</span><br /><br />For some reasons we may need to execute stored procedure and retrieve output value from it. Getting output parameter from stored procedure (e.g. int, or XML as output value(s)).You can call <em>SQLExecuteScalar </em>for retrieve array of output parameters returned by stored procedure. For this you should add them to separate Hashtable. <br /><br /> <em><span class="style2">i<span style="color: #3366ff;">nt myInt = -1; </span></span> <br class="style2" /><span class="style2" style="color: #3366ff;">XmlDocument xd = new XmlDocument() </span><br class="style2" /><span class="style2" style="color: #3366ff;">string outputMessage = string.Empty; </span><br class="style2" /> <br class="style2" /><span class="style2" style="color: #3366ff;"> Hashtable outputParameters = new Hashtable(); </span><br class="style2" /><span class="style2" style="color: #3366ff;">outputParameters["@someIntResult"] = myInt; </span><br class="style2" /><span class="style2" style="color: #3366ff;">outputParameters["@someXMLResult"] = xd; </span><br class="style2" /><span class="style2" style="color: #3366ff;">outputParameters["@someStringResult"] = outputMessage; </span><br class="style2" /> <br class="style2" /><span class="style2" style="color: #3366ff;"> Hashtable inputParameters = new Hashtable(); </span><br class="style2" /><span class="style2" style="color: #3366ff;">inputParameters["@Published"] = true; </span><br class="style2" /><span class="style2" style="color: #3366ff;">object[] result = sqlManager.SQLExecuteScalar("CmsDb", "GetAuthors", inputParameters, outputParameters);</span><br class="style2" /> </em> <br />Thats all for today. The approach described here is successfully used on the web sites e.g. prozarium.ru, in the PGMania program and other projects and showed the best performance results.<br /> <strong> <br /> <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=ea-trifonoff@yandex.ru&amp;lc=US&amp;item_name=CCM (C# Collections Mapper)&amp;no_note=0&amp;no_shipping=2&amp;curency_code=USD&amp;bn=PP-DonationsBF:btn_donateCC_LG.gif:NonHosted" target="_blank" rel="noopener"><span class="alert">How to say thanks?</span></a> </strong><br /><br /> The application is free to download and is distributed under the terms of the MIT license. Don't forget to thank the developer using the Donate link at this page<a href="http://prozarium.ru/TextDetails.aspx?TextID=1410">http://prozarium.ru/TextDetails.aspx?TextID=1410</a></p>
<p>Please read License Agreement for details of using CCM in your projects.<br /><br /></p>
<p>(c)2010-2020 Eugene Trifonov, <br />aka p.v.(pterodactilus vulgaris)<br />Saint Petersburg, Russia<br />mailto: <a href="mailto:pterodactilus@rambler.ru">pterodactilus@rambler.ru</a><br /> Skype <span style="color: #ff9900;">prozarium</span><br /> Telegram <span style="color: #339966;">@EugeneTrifonov</span></p>
<p>Looking for remote work on C#, ASP.Net, MS SQL. <a href="https://spb.hh.ru/resume/78cedb6fff01b150c00039ed1f434c364b7257"><strong>My CV is here</strong></a>.</p>
<p>Offers can be sent via&nbsp;</p>
